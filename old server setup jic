root@ojrd-server-1:~/app# ls
certbot  docker-compose.yml  nginx.conf
root@ojrd-server-1:~/app# cat docker-compose.yml
services:
  # --- MAIN ROUTER ---
  nginx:
    image: nginx:alpine
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    depends_on:
      - package_frontend
      - package_backend
      - metal_frontend
      - metal_backend

  # --- PROJECT 1: PACKAGE SEARCH ---
  package_frontend:
    image: ghcr.io/yigit4416/package_search/frontend:latest
    restart: always

  package_backend:
    image: ghcr.io/yigit4416/package_search/backend:latest
    restart: always
    environment:
      - NODE_ENV=production
      - PORT=3000
      - WINGET_API_LINK=https://api.winget.run/v2/packages?query=
      - PACMAN_API_LINK=https://archlinux.org/packages/search/json/?q=
      - AUR_API_LINK=https://aur.archlinux.org/rpc/v5/search/
      - APT_API_LINK_SPECIFIC=https://sources.debian.org/api/src
      - APT_API_LINK_GENERAL=https://sources.debian.org/api/search

  # --- PROJECT 2: METAL SCRAPER ---
  metal_frontend:
    image: ghcr.io/yigit4416/metal-scraper-frontend:latest
    restart: always

  metal_backend:
    image: ghcr.io/yigit4416/metal-scraper-backend:latest
    restart: always
    shm_size: '1gb' # Vital for Puppeteer
    environment:
      - PORT=3000
      - NODE_ENV=production
root@ojrd-server-1:~/app# cat nginx.conf
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

# HTTP Redirect to HTTPS
server {
    listen 80;
    server_name ojrd.space packages.ojrd.space metal.ojrd.space;
    location /.well-known/acme-challenge/ { root /var/www/certbot; }
    location / { return 301 https://$host$request_uri; }
}

# --- SERVER 1: PACKAGE SEARCH ---
server {
    listen 443 ssl;
    server_name packages.ojrd.space;
    ssl_certificate /etc/letsencrypt/live/packages.ojrd.space/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/packages.ojrd.space/privkey.pem;

    location / {
        proxy_pass http://package_frontend:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    location /api/ {
        proxy_pass http://package_backend:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

# --- SERVER 2: METAL SCRAPER ---
server {
    listen 443 ssl;
    server_name metal.ojrd.space;
    # Using the same cert path (Certbot usually bundles them)
    ssl_certificate /etc/letsencrypt/live/packages.ojrd.space/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/packages.ojrd.space/privkey.pem;

    location / {
        proxy_pass http://metal_frontend:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    # Socket.io Support
    location /socket.io/ {
        proxy_pass http://metal_backend:3000/socket.io/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
   }
 }
root@ojrd-server-1:~/app#
